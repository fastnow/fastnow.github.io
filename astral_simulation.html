<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2D星体模拟器 | 宇宙引力运行规律模拟工具</title>
<meta name="description" content="交互式2D星体引力模拟器，直观展示天体运行物理规律。可调节质量、引力常数等参数，观察多星体系统的复杂运动轨迹，适合天文教学和学习。">
<meta name="keywords" content="星体模拟器,引力模拟工具,宇宙运行模拟,物理仿真软件,天文教学工具,轨道模拟系统">
    <style>
        * {
            box-sizing: border-box;
            touch-action: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #111;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            color: #eee;
        }
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        canvas {
            display: block;
            background-color: #000;
            width: 100%;
            height: 100%;
        }
        .control-panel {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(30, 30, 30, 0.9);
            border-radius: 20px;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        button {
            padding: 8px 12px;
            margin: 0;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            color: #eee;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            min-width: 60px;
            transition: all 0.2s;
            outline: none;
        }
        button:active, button.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .zoom-controls {
            position: fixed;
            right: 10px;
            bottom: 120px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .zoom-controls button {
            width: 44px;
            height: 44px;
            font-size: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: rgba(30, 30, 30, 0.9);
        }
        .status-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .mass-controls {
            position: fixed;
            left: 10px;
            bottom: 120px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .mass-controls button {
            width: 44px;
            height: 44px;
            font-size: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: rgba(30, 30, 30, 0.9);
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            width: 100%;
        }
        input[type="range"] {
            flex-grow: 1;
            margin: 0;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
        }
        .menu-button {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: rgba(30, 30, 30, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
            font-size: 20px;
        }
        .settings-panel {
            position: fixed;
            top: 60px;
            right: 10px;
            background-color: rgba(30, 30, 30, 0.95);
            border-radius: 12px;
            padding: 12px;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 8px;
            width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .settings-panel.visible {
            display: flex;
        }
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .settings-label {
            font-size: 14px;
            white-space: nowrap;
        }
        .settings-value {
            font-size: 14px;
            min-width: 40px;
            text-align: right;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4CAF50;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        @media (max-width: 600px) {
            .control-panel {
                bottom: 5px;
                padding: 6px 10px;
            }
            button {
                padding: 6px 10px;
                font-size: 13px;
                min-width: 50px;
            }
            .settings-panel {
                width: 200px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
<h1 style="display:none;">2D星体运行模拟器</h1>
    <div id="container">
        <canvas id="gravityCanvas"></canvas>
        
        <div class="status-panel">
            <div>天体: <span id="bodyCount">3</span></div>
            <div>缩放: <span id="zoomLevel">1.00</span>x</div>
            <div>帧率: <span id="fpsCounter">0</span> FPS</div>
            <div>时间速度: <span id="timeSpeed">1.0</span>x</div>
        </div>
        
        <div class="menu-button" id="menuBtn">⚙️</div>
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-row">
                <span class="settings-label">显示轨迹</span>
                <label class="switch">
                    <input type="checkbox" id="trailToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <span class="settings-label">显示连线</span>
                <label class="switch">
                    <input type="checkbox" id="lineToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <span class="settings-label">显示速度</span>
                <label class="switch">
                    <input type="checkbox" id="velocityToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-row">
                <span class="settings-label">显示质量</span>
                <label class="switch">
                    <input type="checkbox" id="massToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="slider-container">
                <span class="settings-label">轨迹长度</span>
                <input type="range" id="trailLengthSlider" min="10" max="200" value="50">
                <span class="settings-value" id="trailLengthValue">50</span>
            </div>
            <div class="slider-container">
                <span class="settings-label">时间速度</span>
                <input type="range" id="timeSpeedSlider" min="10" max="200" value="100">
                <span class="settings-value" id="timeSpeedValue">1.0</span>
            </div>
            <div class="slider-container">
                <span class="settings-label">引力常数</span>
                <input type="range" id="gSlider" min="1" max="100" value="20">
                <span class="settings-value" id="gValue">20</span>
            </div>
            <footer style="margin-top: 20px; font-size: 0.8rem; color: #666; text-align: center;"> &copy; <script>document.write(new Date().getFullYear())</script> FastNow Studio | BSD 3-Clause</footer>
        </div>
        
        <div class="mass-controls">
            <button id="addMassBtn">+M</button>
            <button id="reduceMassBtn">-M</button>
            <button id="addBodyBtn">+★</button>
        </div>
        
        <div class="zoom-controls">
            <button id="zoomInBtn">+</button>
            <button id="zoomOutBtn">-</button>
            <button id="resetZoomBtn">1x</button>
            <button id="centerViewBtn">⌖</button>
        </div>
        
        <div class="control-panel">
            <button id="startBtn">开始</button>
            <button id="resetBtn">重置</button>
            <button id="randomBtn">随机</button>
        </div>
    </div>
    
    <script>
        // 性能优化：使用requestAnimationFrame的polyfill
        (function() {
            var lastTime = 0;
            var vendors = ['ms', 'moz', 'webkit', 'o'];
            for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                           || window[vendors[x]+'CancelRequestAnimationFrame'];
            }
            
            if (!window.requestAnimationFrame)
                window.requestAnimationFrame = function(callback, element) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                    var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
                      timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            
            if (!window.cancelAnimationFrame)
                window.cancelAnimationFrame = function(id) {
                    clearTimeout(id);
                };
        }());

        // 调整canvas大小以适应窗口
        function resizeCanvas() {
            const canvas = document.getElementById('gravityCanvas');
            const pixelRatio = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * pixelRatio;
            canvas.height = window.innerHeight * pixelRatio;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            return canvas;
        }

        // 星体类
        class Body {
            constructor(x, y, dx, dy, m, color = null) {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.m = m;
                this.color = color || this.getRandomColor();
                this.trail = [];
                this.maxTrailLength = 50;
                this.selected = false;
                this.following = false;
            }
            
            getRandomColor() {
                const colors = ['#ff5e5e', '#5e8cff', '#5eff8c', '#ffcc5e', '#cc5eff', '#ff7eb9', '#7afcff'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            update(dt) {
                this.x += this.dx * dt;
                this.y += this.dy * dt;
                
                // 记录轨迹
                if (this.trail.length >= this.maxTrailLength) {
                    this.trail.shift();
                }
                this.trail.push({x: this.x, y: this.y});
            }
            
            applyForce(other, g, dt) {
                const dx = other.x - this.x;
                const dy = other.y - this.y;
                const distSq = dx * dx + dy * dy;
                const minDist = 50;
                const dist = Math.sqrt(Math.max(distSq, minDist * minDist));
                
                const f = g * other.m / (dist * dist * dist) * dt;
                this.dx += dx * f;
                this.dy += dy * f;
            }
            
            getRadius() {
                return Math.min(Math.max(Math.sqrt(this.m) * 0.5, 3), 20);
            }
            
            draw(ctx, scale, showTrail, showVelocity, showMass, selected = false) {
                const radius = this.getRadius() / scale;
                const scaledRadius = Math.max(radius, 4 / scale); // 确保在缩放时仍可点击
                
                // 绘制轨迹
                if (showTrail && this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    
                    // 性能优化：减少绘制点
                    const step = Math.max(1, Math.floor(this.trail.length / 50));
                    for (let i = 1; i < this.trail.length; i += step) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    
                    ctx.strokeStyle = this.color + '80';
                    ctx.lineWidth = 2 / scale;
                    ctx.stroke();
                }
                
                // 绘制星体
                ctx.beginPath();
                ctx.arc(this.x, this.y, scaledRadius, 0, Math.PI * 2);
                ctx.fillStyle = selected ? '#fff' : this.color;
                ctx.fill();
                
                // 选中状态外框
                if (selected) {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, scaledRadius + 5/scale, 0, Math.PI * 2);
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2/scale;
                    ctx.stroke();
                }
                
                // 绘制速度向量
                if (showVelocity) {
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.dx * 10, this.y + this.dy * 10);
                    ctx.strokeStyle = '#ffffff90';
                    ctx.lineWidth = 1.5 / scale;
                    ctx.stroke();
                }
                
                // 绘制质量标签
                if (showMass) {
                    const fontSize = Math.max(12, 12 / scale);
                    ctx.font = `${fontSize}px Arial`;
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.m.toFixed(0), this.x, this.y - scaledRadius - 10/scale);
                }
            }
        }

        // 模拟器类
        class GravitySimulator {
            constructor() {
                this.bodies = [];
                this.g = 20;
                this.dt = 1.0;
                this.timeScale = 1.0;
                this.running = false;
                this.animationId = null;
                this.lastTime = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                
                // 显示设置
                this.showTrails = true;
                this.showLines = true;
                this.showVelocities = true;
                this.showMasses = true;
                this.trailLength = 50;
                
                // 视图控制
                this.view = {
                    x: 0,
                    y: 0,
                    scale: 1,
                    targetScale: 1,
                    width: window.innerWidth,
                    height: window.innerHeight,
                    followingBody: null,
                    smoothFollow: true
                };
                
                this.selectedBody = null;
                this.lastTouch = { x: 0, y: 0 };
                this.touchStartDist = 0;
                this.initialScale = 1;
                this.pointerDown = false;
                this.pinchZoom = false;
            }
            
            init(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                const pixelRatio = window.devicePixelRatio || 1;
                this.ctx.scale(pixelRatio, pixelRatio);
                this.view.width = canvas.width / pixelRatio;
                this.view.height = canvas.height / pixelRatio;
                
                // 初始三个星体
                this.reset();
                this.setupControls();
                this.setupEvents();
                this.render(performance.now());
            }
            
            setupControls() {
                // 按钮事件
                document.getElementById('startBtn').addEventListener('click', () => this.toggleRunning());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                document.getElementById('randomBtn').addEventListener('click', () => this.randomize());
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomAtCenter(1.5));
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomAtCenter(1/1.5));
                document.getElementById('resetZoomBtn').addEventListener('click', () => this.resetZoom());
                document.getElementById('centerViewBtn').addEventListener('click', () => this.centerView());
                document.getElementById('addBodyBtn').addEventListener('click', () => this.addBody());
                document.getElementById('addMassBtn').addEventListener('click', () => this.adjustMass(20));
                document.getElementById('reduceMassBtn').addEventListener('click', () => this.adjustMass(-20));
                document.getElementById('menuBtn').addEventListener('click', () => this.toggleSettings());
                
                // 设置面板
                document.getElementById('trailToggle').addEventListener('change', (e) => {
                    this.showTrails = e.target.checked;
                });
                document.getElementById('lineToggle').addEventListener('change', (e) => {
                    this.showLines = e.target.checked;
                });
                document.getElementById('velocityToggle').addEventListener('change', (e) => {
                    this.showVelocities = e.target.checked;
                });
                document.getElementById('massToggle').addEventListener('change', (e) => {
                    this.showMasses = e.target.checked;
                });
                document.getElementById('trailLengthSlider').addEventListener('input', (e) => {
                    this.trailLength = parseInt(e.target.value);
                    document.getElementById('trailLengthValue').textContent = this.trailLength;
                    this.bodies.forEach(body => body.maxTrailLength = this.trailLength);
                });
                document.getElementById('timeSpeedSlider').addEventListener('input', (e) => {
                    this.timeScale = parseFloat(e.target.value) / 100;
                    document.getElementById('timeSpeedValue').textContent = this.timeScale.toFixed(1);
                    document.getElementById('timeSpeed').textContent = this.timeScale.toFixed(1);
                });
                document.getElementById('gSlider').addEventListener('input', (e) => {
                    this.g = parseInt(e.target.value);
                    document.getElementById('gValue').textContent = this.g;
                });
            }
            
            setupEvents() {
                const canvas = this.canvas;
                
                // 鼠标/触摸事件
                canvas.addEventListener('pointerdown', this.handlePointerStart.bind(this));
                canvas.addEventListener('pointermove', this.handlePointerMove.bind(this));
                document.addEventListener('pointerup', this.handlePointerEnd.bind(this));
                
                // 防止触摸事件导致页面滚动
                canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
                canvas.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                
                // 窗口大小改变
                window.addEventListener('resize', () => {
                    const canvas = resizeCanvas();
                    const pixelRatio = window.devicePixelRatio || 1;
                    this.view.width = canvas.width / pixelRatio;
                    this.view.height = canvas.height / pixelRatio;
                });
            }
            
            handlePointerStart(e) {
                this.pointerDown = true;
                const rect = this.canvas.getBoundingClientRect();
                this.lastTouch = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                
                // 检查是否选中了星体
                const worldPos = this.screenToWorld(this.lastTouch.x, this.lastTouch.y);
                this.selectedBody = this.getBodyAt(worldPos.x, worldPos.y, this.view.scale);
                
                // 如果在暂停状态且选中了星体，则锁定视角
                if (!this.running && this.selectedBody) {
                    this.view.followingBody = this.selectedBody;
                    this.selectedBody.following = true;
                    this.centerOnBody(this.selectedBody);
                }
            }
            
            handlePointerMove(e) {
                if (!this.pointerDown) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.selectedBody) {
                    // 移动选中的星体
                    const worldPos = this.screenToWorld(x, y);
                    this.selectedBody.x = worldPos.x;
                    this.selectedBody.y = worldPos.y;
                    this.selectedBody.trail = []; // 清除轨迹
                    
                    // 如果正在跟随，更新视图中心
                    if (this.view.followingBody === this.selectedBody) {
                        this.view.x = this.selectedBody.x;
                        this.view.y = this.selectedBody.y;
                    }
                } else {
                    // 平移视图
                    const dx = x - this.lastTouch.x;
                    const dy = y - this.lastTouch.y;
                    this.pan(dx, dy);
                    this.view.followingBody = null; // 停止跟随
                }
                
                this.lastTouch = { x, y };
            }
            
            handlePointerEnd() {
                this.pointerDown = false;
                if (this.selectedBody) {
                    this.selectedBody.following = false;
                }
                this.selectedBody = null;
            }
            
            getBodyAt(x, y, scale) {
                // 根据当前缩放级别调整点击检测半径
                const minClickRadius = 15 / scale;
                
                for (let i = this.bodies.length - 1; i >= 0; i--) {
                    const body = this.bodies[i];
                    const dist = Math.hypot(x - body.x, y - body.y);
                    const bodyRadius = Math.max(body.getRadius(), minClickRadius);
                    if (dist < bodyRadius) {
                        return body;
                    }
                }
                return null;
            }
            
            screenToWorld(x, y) {
                return {
                    x: (x - this.view.width / 2) / this.view.scale + this.view.x,
                    y: (y - this.view.height / 2) / this.view.scale + this.view.y
                };
            }
            
            worldToScreen(x, y) {
                return {
                    x: (x - this.view.x) * this.view.scale + this.view.width / 2,
                    y: (y - this.view.y) * this.view.scale + this.view.height / 2
                };
            }
            
            pan(dx, dy) {
                this.view.x -= dx / this.view.scale;
                this.view.y -= dy / this.view.scale;
            }
            
            zoomAtCenter(factor) {
                const oldScale = this.view.targetScale;
                this.view.targetScale *= factor;
                
                // 无限缩放 (0.01x 到 1000x)
                this.view.targetScale = Math.max(0.01, Math.min(this.view.targetScale, 1000));
                
                // 以屏幕中心为中心缩放，不改变视图中心
                this.updateZoomDisplay();
            }
            
            resetZoom() {
                this.view.targetScale = 1;
                this.updateZoomDisplay();
            }
            
            centerView() {
                if (this.bodies.length === 0) return;
                
                // 计算所有星体的边界
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                this.bodies.forEach(body => {
                    minX = Math.min(minX, body.x);
                    maxX = Math.max(maxX, body.x);
                    minY = Math.min(minY, body.y);
                    maxY = Math.max(maxY, body.y);
                });
                
                // 计算中心点和所需缩放级别
                const centerX = (minX + maxX) / 2;
                const centerY = (minY + maxY) / 2;
                const width = maxX - minX;
                const height = maxY - minY;
                
                // 添加一些边距
                const margin = 50;
                const scaleX = this.view.width / (width + margin);
                const scaleY = this.view.height / (height + margin);
                
                this.view.x = centerX;
                this.view.y = centerY;
                this.view.targetScale = Math.min(scaleX, scaleY, 1);
                
                this.updateZoomDisplay();
            }
            
            centerOnBody(body) {
                this.view.x = body.x;
                this.view.y = body.y;
                // 设置一个适当的缩放级别以便观察
                this.view.targetScale = Math.min(1, 200 / body.getRadius());
                this.updateZoomDisplay();
            }
            
            updateZoomDisplay() {
                document.getElementById('zoomLevel').textContent = this.view.scale.toFixed(2);
            }
            
            updatePhysics(dt) {
                // 应用时间缩放
                const scaledDt = dt * this.timeScale;
                
                // 计算引力
                for (let i = 0; i < this.bodies.length; i++) {
                    for (let j = i + 1; j < this.bodies.length; j++) {
                        this.bodies[i].applyForce(this.bodies[j], this.g, scaledDt);
                        this.bodies[j].applyForce(this.bodies[i], this.g, scaledDt);
                    }
                }
                
                // 更新位置
                this.bodies.forEach(body => body.update(scaledDt));
                
                // 平滑跟随选中的星体
                if (this.view.followingBody && this.view.smoothFollow && !this.pointerDown) {
                    const followSpeed = 0.1;
                    this.view.x += (this.view.followingBody.x - this.view.x) * followSpeed;
                    this.view.y += (this.view.followingBody.y - this.view.y) * followSpeed;
                }
            }
            
            render(time) {
                // 计算帧率
                this.calculateFPS(time);
                
                // 平滑缩放
                if (Math.abs(this.view.scale - this.view.targetScale) > 0.001) {
                    this.view.scale += (this.view.targetScale - this.view.scale) * 0.1;
                    this.updateZoomDisplay();
                }
                
                const ctx = this.ctx;
                ctx.save();
                
                // 清空画布
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 应用视图变换
                ctx.translate(this.view.width / 2, this.view.height / 2);
                ctx.scale(this.view.scale, this.view.scale);
                ctx.translate(-this.view.x, -this.view.y);
                
                // 绘制连线
                if (this.showLines && this.bodies.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.bodies[0].x, this.bodies[0].y);
                    for (let i = 1; i < this.bodies.length; i++) {
                        ctx.lineTo(this.bodies[i].x, this.bodies[i].y);
                    }
                    ctx.closePath();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineWidth = 1 / this.view.scale;
                    ctx.stroke();
                }
                
                // 绘制星体
                this.bodies.forEach(body => {
                    body.draw(
                        ctx, 
                        this.view.scale, 
                        this.showTrails,
                        this.showVelocities,
                        this.showMasses,
                        body === this.selectedBody || body === this.view.followingBody
                    );
                });
                
                ctx.restore();
                
                // 更新状态显示
                document.getElementById('bodyCount').textContent = this.bodies.length;
                
                // 继续动画循环
                this.animationId = requestAnimationFrame((t) => {
                    if (this.running) {
                        const deltaTime = Math.min(50, t - this.lastTime) / 1000;
                        this.updatePhysics(this.dt * deltaTime * 60);
                        this.lastTime = t;
                    }
                    this.render(t);
                });
            }
            
            calculateFPS(time) {
                this.frameCount++;
                if (time - this.lastFpsUpdate >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsUpdate = time;
                    document.getElementById('fpsCounter').textContent = this.fps;
                }
            }
            
            start() {
                if (!this.running) {
                    this.running = true;
                    this.lastTime = performance.now();
                    document.getElementById('startBtn').textContent = '暂停';
                    document.getElementById('startBtn').classList.add('active');
                }
            }
            
            stop() {
                this.running = false;
                document.getElementById('startBtn').textContent = '开始';
                document.getElementById('startBtn').classList.remove('active');
            }
            
            toggleRunning() {
                this.running ? this.stop() : this.start();
            }
            
            reset() {
                this.stop();
                this.bodies = [
                    new Body(-200, 0, 0, -1.5, 150),
                    new Body(200, -150, 1.5, 0.5, 150),
                    new Body(100, 200, -1, -0.5, 150)
                ];
                this.view.followingBody = null;
                this.selectedBody = null;
                this.resetZoom();
                this.centerView();
            }
            
            randomize() {
                this.stop();
                const range = 2000;
                const speedRange = 1.5;
                const massRange = 100;
                
                this.bodies = Array.from({ length: 3 }, () => {
                    return new Body(
                        (Math.random() - 0.5) * range,
                        (Math.random() - 0.5) * range,
                        (Math.random() - 0.5) * speedRange,
                        (Math.random() - 0.5) * speedRange,
                        100 + Math.random() * massRange
                    );
                });
                this.view.followingBody = null;
                this.selectedBody = null;
                this.centerView();
            }
            
            addBody() {
                const range = 500 / this.view.scale;
                this.bodies.push(new Body(
                    this.view.x + (Math.random() - 0.5) * range,
                    this.view.y + (Math.random() - 0.5) * range,
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 0.5,
                    100 + Math.random() * 100
                ));
            }
            
            adjustMass(amount) {
                const target = this.view.followingBody || this.selectedBody || (this.bodies.length > 0 ? this.bodies[0] : null);
                if (target) {
                    target.m = Math.max(10, target.m + amount);
                }
            }
            
            toggleSettings() {
                document.getElementById('settingsPanel').classList.toggle('visible');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = resizeCanvas();
            const simulator = new GravitySimulator();
            simulator.init(canvas);
        });
    </script>
</body>
</html>
