<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="专业面部比例评定系统，基于科学测量分析面部三庭五眼、五官比例、对称性和面部轮廓，提供个性化评估报告和美容建议。在线面部美学分析工具。">
    <meta name="keywords" content="面部比例分析, 面部测量, 三庭五眼测量, 面部美学评估, 五官比例分析, 面部对称性检测, 脸型分析, 面部黄金比例, 在线面部评估">
    <title>面部比例评定系统 | 在线面部美学分析工具 | 面部比例测量</title>
    <meta name="author" content="FastNow Studio">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI','Microsoft YaHei',sans-serif}
        body{color:#333;line-height:1.6;}
        .container{margin:0 auto;background:#fff;overflow:hidden}
        header{background:#4b6cb7;color:#fff;padding:25px;text-align:center}
        h1{font-size:2rem;margin-bottom:8px;font-weight:600}
        .subtitle{font-size:0.95rem;opacity:0.9;max-width:700px;margin:0 auto}
        .progress-container{background:#f8f9fa;padding:12px;display:flex;justify-content:center;border-bottom:1px solid #e9ecef}
        .progress-step{display:flex;align-items:center;margin:0 8px;color:#6c757d;font-size:0.85rem}
        .progress-step.active{color:#4b6cb7;font-weight:600}
        .progress-step.completed{color:#28a745}
        .step-number{display:inline-block;width:22px;height:22px;line-height:22px;border-radius:50%;background:#dee2e6;text-align:center;margin-right:6px;font-size:0.75rem}
        .progress-step.active .step-number{background:#4b6cb7;color:#fff}
        .progress-step.completed .step-number{background:#28a745;color:#fff}
        .main-content{display:flex;flex-wrap:wrap;padding:20px;min-height:600px}
        .left-panel,.right-panel{flex:1;padding:20px;min-width:300px}
        .panel-title{font-size:1.2rem;color:#212529;margin-bottom:15px;padding-bottom:8px;border-bottom:1px solid #e9ecef}
        .media-section{background:#f8f9fa;border-radius:8px;padding:18px;margin-bottom:18px}
        .gender-selection{margin-top:15px;display:flex;gap:15px}
        .gender-btn{flex:1;padding:12px;border:2px solid #dee2e6;border-radius:8px;background:#fff;cursor:pointer;text-align:center;font-weight:500;transition:all 0.2s}
        .gender-btn.selected{border-color:#4b6cb7;background:#e7f3ff;color:#4b6cb7}
        .gender-btn:hover{border-color:#adb5bd}
        .media-options{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
        .btn{padding:10px 18px;border:none;border-radius:6px;font-weight:500;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.9rem}
        .btn-primary{background:#4b6cb7;color:#fff}
        .btn-primary:hover:not(:disabled){background:#3a5690}
        .btn-primary:disabled{background:#adb5bd;cursor:not-allowed}
        .btn-secondary{background:#e9ecef;color:#495057;border:1px solid #ced4da}
        .btn-secondary:hover{background:#dee2e6}
        .image-container{position:relative;width:100%;height:380px;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;background:#f8f9fa;display:flex;align-items:center;justify-content:center;margin-bottom:18px}
        #faceImage{max-width:100%;max-height:100%;display:none}
        .placeholder-text{text-align:center;color:#6c757d;padding:20px;font-size:0.95rem}
        .measure-point{position:absolute;width:0;height:0;cursor:move;z-index:10;pointer-events:auto;transform:translate(-50%,-50%);transition:all 0.1s}
        .measure-point:before{content:'';position:absolute;top:-20px;left:-20px;width:40px;height:40px;border:3px solid #4b6cb7;border-radius:50%;background:rgba(75,108,183,0.2)}
        .measure-point:after{content:'';position:absolute;top:0;left:0;width:6px;height:6px;background:#4b6cb7;border-radius:50%;transform:translate(-50%,-50%)}
        .measure-point.active:before{border-color:#ff4444;background:rgba(255,68,68,0.2)}
        .measure-point.active:after{background:#ff4444}
        .measure-point.inactive:before{width:8px;height:8px;top:-4px;left:-4px;border-width:1px;border-color:#6c757d;background:rgba(108,117,125,0.2)}
        .measure-point.inactive:after{width:3px;height:3px;background:#6c757d}
        .current-point-info{background:#f8f9fa;border-radius:8px;padding:15px;margin-bottom:18px;text-align:center}
        .point-name{font-size:1.1rem;color:#212529;margin-bottom:5px}
        .point-desc{color:#6c757d;font-size:0.85rem;margin-bottom:12px}
        .point-counter{font-size:0.85rem;color:#4b6cb7;font-weight:600}
        .slider-container{background:#f8f9fa;border-radius:8px;padding:18px;margin-bottom:18px}
        .control-group{margin-bottom:15px}
        .slider-with-value{display:flex;align-items:center;gap:12px}
        .slider-value{min-width:36px;font-weight:600;color:#4b6cb7;font-size:0.9rem}
        input[type="range"]{flex:1;height:6px;border-radius:3px;background:#dee2e6;outline:none}
        .step-controls{display:flex;justify-content:space-between;margin-top:18px}
        .analysis-button-container{text-align:center;margin-top:18px}
        .result-section{background:#f8f9fa;border-radius:8px;padding:20px}
        .overall-score{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e9ecef}
        .grade{font-size:3rem;font-weight:700;color:#4b6cb7}
        .score-details{text-align:right}
        .score-label{font-size:0.85rem;color:#6c757d}
        .score-value{font-size:1.6rem;font-weight:700;color:#212529}
        .assessment-list{list-style-type:none;margin-bottom:20px}
        .assessment-item{padding:10px 0;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center}
        .assessment-item:last-child{border-bottom:none}
        .assessment-title{font-weight:500;color:#212529;flex:1;font-size:0.95rem}
        .assessment-score{font-weight:600;color:#212529;margin-right:12px;min-width:36px;text-align:right;font-size:0.95rem}
        .score-bar{height:6px;background:#dee2e6;border-radius:3px;width:120px;overflow:hidden;margin-right:12px}
        .score-fill{height:100%;border-radius:3px}
        .score-fill.excellent{background:#28a745}
        .score-fill.good{background:#20c997}
        .score-fill.average{background:#ffc107}
        .score-fill.poor{background:#dc3545}
        .assessment-rating{font-weight:600;padding:3px 8px;border-radius:12px;font-size:0.8rem;min-width:50px;text-align:center}
        .rating-A{background:rgba(40,167,69,0.15);color:#28a745}
        .rating-B{background:rgba(32,201,151,0.15);color:#20c997}
        .rating-C{background:rgba(255,193,7,0.15);color:#ffc107}
        .rating-D{background:rgba(220,53,69,0.15);color:#dc3545}
        .detailed-report{margin-top:20px;padding:18px;background:#fff;border-radius:8px;border:1px solid #e9ecef;line-height:1.6;max-height:500px;overflow-y:auto}
        .report-title{font-size:1.1rem;margin-bottom:8px;color:#212529;font-weight:600}
        .report-section{margin-bottom:18px;padding-bottom:15px;border-bottom:1px solid #e9ecef}
        .report-data{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px}
        .data-item{background:#f8f9fa;border-radius:6px;padding:10px 12px;flex:1;min-width:110px;border:1px solid #e9ecef}
        .data-label{font-size:0.85rem;color:#6c757d;margin-bottom:5px}
        .data-value{font-size:1.1rem;font-weight:600;color:#212529}
        .data-ideal{font-size:0.8rem;color:#4b6cb7;margin-top:3px}
        .data-reference{font-size:0.8rem;color:#6c757d;margin-top:2px}
        .report-suggestion{background:#f8f9fa;border-left:3px solid #4b6cb7;padding:12px;margin-top:15px;border-radius:0 6px 6px 0}
        footer{text-align:center;padding:18px;color:#6c757d;font-size:0.85rem;border-top:1px solid #e9ecef}
        @media(max-width:900px){.main-content{flex-direction:column}.left-panel,.right-panel{width:100%}.score-bar{width:80px}}
        .measure-line{position:absolute;pointer-events:none;z-index:5}
        .report-mode .line-label{display:none}
        .camera-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center}
        .modal-content{background:#fff;padding:25px;border-radius:10px;max-width:700px;width:90%}
        .measurement-hint{margin-top:10px;padding:8px;background:#fff3cd;border-radius:4px;border:1px solid #ffc107;font-size:0.85rem;color:#856404}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>面部比例评定系统</h1>
            <p class="subtitle">科学测量面部比例，提供个性化评估报告</p>
        </header>
        <div class="progress-container">
            <div class="progress-step completed" id="step1"><span class="step-number">1</span><span>上传图片</span></div>
            <div class="progress-step active" id="step2"><span class="step-number">2</span><span>定位测量点</span></div>
            <div class="progress-step" id="step3"><span class="step-number">3</span><span>获取报告</span></div>
        </div>
        <div class="main-content">
            <div class="left-panel">
                <h2 class="panel-title">面部测量</h2>
                <div class="media-section" id="mediaSection">
                    <p>请选择性别：</p>
                    <div class="gender-selection">
                        <div class="gender-btn" id="maleBtn">男性</div>
                        <div class="gender-btn selected" id="femaleBtn">女性</div>
                    </div>
                    <p style="margin-top:15px">请选择一种方式获取面部正面图像：</p>
                    <div class="media-options">
                        <button id="cameraBtn" class="btn btn-primary">使用摄像头</button>
                        <button id="uploadBtn" class="btn btn-secondary">从相册上传</button>
                    </div>
                </div>
                <div class="image-container" id="imageContainer">
                    <div class="placeholder-text" id="placeholder">请上传面部正面图像开始测量</div>
                    <img id="faceImage" src="" alt="面部图像">
                </div>
                <div class="current-point-info" id="currentPointInfo" style="display:none">
                    <div class="point-name" id="currentPointName">额头中心点</div>
                    <div class="point-desc" id="currentPointDesc">请定位到额头的中心位置</div>
                    <div class="point-counter" id="pointCounter">1/21</div>
                </div>
                <div class="slider-container" id="sliderContainer" style="display:none">
                    <h3>微调位置</h3>
                    <p>拖拽测量点移动位置，或使用滑块微调</p>
                    <div class="control-group">
                        <div class="slider-with-value">
                            <span>水平位置：</span>
                            <input type="range" id="xSlider" min="0" max="100" value="50">
                            <span class="slider-value" id="xValue">50</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="slider-with-value">
                            <span>垂直位置：</span>
                            <input type="range" id="ySlider" min="0" max="100" value="50">
                            <span class="slider-value" id="yValue">50</span>
                        </div>
                    </div>
                    <div class="measurement-hint">提示：点击图片任意位置可快速定位测量点，拖拽可精细调整</div>
                    <div class="step-controls">
                        <button id="prevPointBtn" class="btn btn-secondary" style="display:none">上一步</button>
                        <button id="nextPointBtn" class="btn btn-primary">完成并继续</button>
                    </div>
                </div>
                <div class="analysis-button-container">
                    <button id="analyzeBtn" class="btn btn-primary" style="display:none">开始面部比例分析</button>
                </div>
            </div>
            <div class="right-panel">
                <h2 class="panel-title">面部比例评估结果</h2>
                <div class="result-section" id="resultSection" style="display:none">
                    <div class="overall-score">
                        <div><div class="grade" id="overallGrade">-</div><div>综合评分</div></div>
                        <div class="score-details"><div class="score-label">面部比例指数</div><div class="score-value" id="proportionScore">-</div></div>
                    </div>
                    <ul class="assessment-list" id="assessmentList"></ul>
                    <div class="detailed-report" id="detailedReport">
                        <h3 class="report-title">详细评估报告</h3>
                        <div id="reportText">请先完成面部图像测量点定位，然后点击"开始面部比例分析"按钮获取详细评估报告。</div>
                    </div>
                </div>
                <div id="instructions" style="padding:20px">
                    <h3>使用说明</h3>
                    <ol style="margin-top:12px;padding-left:20px">
                        <li>选择性别并上传或拍摄一张清晰的正面面部照片</li>
                        <li>按照系统提示，依次定位21个面部关键测量点</li>
                        <li>点击图片任意位置可快速定位测量点</li>
                        <li>拖拽测量点可精细调整位置</li>
                        <li>完成所有点定位后，系统将进行全面的面部分析</li>
                    </ol>
                    <div style="margin-top:18px;padding:12px;background:#f8f9fa;border-radius:6px;border:1px solid #e9ecef">
                        <h4>测量点说明</h4>
                        <p>本次测量包括面部三庭五眼、五官比例、对称性、面部轮廓形状等多项指标。</p>
                    </div>
                </div>
            </div>
        </div>
        <footer>&copy; <script>document.write(new Date().getFullYear())</script> FastNow Studio | BSD 3-Clause</p></footer>
    </div>
    <div class="camera-modal" id="cameraModal">
        <div class="modal-content">
            <h2>拍摄面部照片</h2>
            <div style="position:relative;width:100%;height:350px;background:#000;border-radius:8px;overflow:hidden">
                <video id="cameraFeed" autoplay playsinline style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
                <div style="position:absolute;top:0;left:0;width:100%;height:100%;border:2px solid rgba(255,255,255,0.4);pointer-events:none"></div>
            </div>
            <div style="display:flex;gap:12px;margin-top:15px">
                <button id="captureBtn" class="btn btn-primary" style="flex:1">拍摄照片</button>
                <button id="closeCameraBtn" class="btn btn-secondary" style="flex:1">关闭摄像头</button>
            </div>
            <p style="margin-top:12px">提示：请确保面部正对摄像头，光线充足，背景简洁</p>
        </div>
    </div>
    <script>
        // 状态变量
        let selectedGender='female',currentStep=0,points=[],currentPoint=null,stream=null,isDragging=false,activePoint=null;
        
        // 测量点数据
        const measurementPoints=[
            {id:1,name:"发际线中点",desc:"前额发际线中心点",x:50,y:12},
            {id:2,name:"额头中心点",desc:"额头的中心位置",x:50,y:20},
            {id:3,name:"左眉外侧点",desc:"左侧眉毛最外侧点",x:35,y:32},
            {id:4,name:"右眉外侧点",desc:"右侧眉毛最外侧点",x:65,y:32},
            {id:5,name:"左眉峰点",desc:"左侧眉毛最高点",x:42,y:30},
            {id:6,name:"右眉峰点",desc:"右侧眉毛最高点",x:58,y:30},
            {id:7,name:"左眼外角",desc:"左眼外眼角位置",x:35,y:40},
            {id:8,name:"右眼外角",desc:"右眼外眼角位置",x:65,y:40},
            {id:9,name:"左眼内角",desc:"左眼内眼角位置",x:45,y:40},
            {id:10,name:"右眼内角",desc:"右眼内眼角位置",x:55,y:40},
            {id:11,name:"鼻根点",desc:"两眼中点，鼻子起始处",x:50,y:44},
            {id:12,name:"鼻尖点",desc:"鼻子最突出的点",x:50,y:56},
            {id:13,name:"左鼻翼点",desc:"左侧鼻翼最外侧点",x:44,y:56},
            {id:14,name:"右鼻翼点",desc:"右侧鼻翼最外侧点",x:56,y:56},
            {id:15,name:"左嘴角",desc:"左侧嘴角位置",x:42,y:66},
            {id:16,name:"右嘴角",desc:"右侧嘴角位置",x:58,y:66},
            {id:17,name:"上唇中点",desc:"上唇弓形最高点",x:50,y:64},
            {id:18,name:"下唇中点",desc:"下唇最丰满点",x:50,y:68},
            {id:19,name:"下巴中心点",desc:"下巴最低点的中心位置",x:50,y:86},
            {id:20,name:"左颧骨点",desc:"左侧颧骨最突出点",x:38,y:52},
            {id:21,name:"右颧骨点",desc:"右侧颧骨最突出点",x:62,y:52}
        ];
        
        // 初始化
        document.addEventListener('DOMContentLoaded',()=>{
            // 事件监听
            document.getElementById('cameraBtn').addEventListener('click',openCamera);
            document.getElementById('uploadBtn').addEventListener('click',()=>{
                const fileInput=document.createElement('input');
                fileInput.type='file';
                fileInput.accept='image/*';
                fileInput.onchange=e=>handleImageUpload(e);
                fileInput.click();
            });
            document.getElementById('xSlider').addEventListener('input',updatePointPosition);
            document.getElementById('ySlider').addEventListener('input',updatePointPosition);
            document.getElementById('nextPointBtn').addEventListener('click',goToNextPoint);
            document.getElementById('prevPointBtn').addEventListener('click',goToPrevPoint);
            document.getElementById('analyzeBtn').addEventListener('click',analyzeFaceProportions);
            document.getElementById('captureBtn').addEventListener('click',capturePhoto);
            document.getElementById('closeCameraBtn').addEventListener('click',closeCamera);
            document.getElementById('maleBtn').addEventListener('click',()=>selectGender('male'));
            document.getElementById('femaleBtn').addEventListener('click',()=>selectGender('female'));
            
            // 图片容器事件
            const imageContainer=document.getElementById('imageContainer');
            imageContainer.addEventListener('mousedown',startDrag);
            imageContainer.addEventListener('mousemove',doDrag);
            imageContainer.addEventListener('mouseup',endDrag);
            imageContainer.addEventListener('mouseleave',endDrag);
            imageContainer.addEventListener('click',handleImageClick);
            
            // 触摸事件支持
            imageContainer.addEventListener('touchstart',startDragTouch,{passive:false});
            imageContainer.addEventListener('touchmove',doDragTouch,{passive:false});
            imageContainer.addEventListener('touchend',endDrag);
            
            resetPoints();
            updateProgress();
        });
        
        function selectGender(gender){
            selectedGender=gender;
            document.getElementById('maleBtn').classList.toggle('selected',gender==='male');
            document.getElementById('femaleBtn').classList.toggle('selected',gender==='female');
        }
        
        function resetPoints(){
            points=JSON.parse(JSON.stringify(measurementPoints));
            currentStep=0;
            document.querySelectorAll('.measure-point,.measure-line,.line-label').forEach(el=>el.remove());
        }
        
        function handleImageUpload(e){
            const file=e.target.files[0];
            if(!file)return;
            const reader=new FileReader();
            reader.onload=event=>loadImage(event.target.result);
            reader.readAsDataURL(file);
        }
        
        function loadImage(imageSrc){
            document.getElementById('faceImage').src=imageSrc;
            document.getElementById('faceImage').style.display='block';
            document.getElementById('placeholder').style.display='none';
            startMeasurementProcess();
        }
        
        function startMeasurementProcess(){
            currentStep=1;
            updateProgress();
            showCurrentPoint();
            document.getElementById('currentPointInfo').style.display='block';
            document.getElementById('sliderContainer').style.display='block';
            document.getElementById('analyzeBtn').style.display='none';
            document.getElementById('mediaSection').style.display='none';
        }
        
        function updateProgress(){
            for(let i=1;i<=3;i++){
                const step=document.getElementById(`step${i}`);
                if(i===1)step.className=currentStep>=1?'progress-step completed':'progress-step';
                else if(i===2){
                    if(currentStep>=1&&currentStep<=21)step.className='progress-step active';
                    else if(currentStep>21)step.className='progress-step completed';
                    else step.className='progress-step';
                }
                else if(i===3)step.className=currentStep>21?'progress-step active':'progress-step';
            }
        }
        
        function showCurrentPoint(){
            if(currentStep<1||currentStep>21)return;
            const point=points.find(p=>p.id===currentStep);
            if(!point)return;
            document.getElementById('currentPointName').textContent=point.name;
            document.getElementById('currentPointDesc').textContent=point.desc;
            document.getElementById('pointCounter').textContent=`${currentStep}/21`;
            document.getElementById('xSlider').value=point.x;
            document.getElementById('ySlider').value=point.y;
            document.getElementById('xValue').textContent=point.x;
            document.getElementById('yValue').textContent=point.y;
            document.getElementById('nextPointBtn').textContent=currentStep===21?'完成测量':'完成并继续';
            document.getElementById('prevPointBtn').style.display=currentStep>1?'inline-block':'none';
            createOrUpdateMeasurementPoint(point);
            drawMeasurementLines();
        }
        
        function createOrUpdateMeasurementPoint(point){
            document.querySelectorAll('.measure-point').forEach(el=>el.remove());
            const pointEl=document.createElement('div');
            pointEl.className='measure-point active';
            pointEl.id=`point-${point.id}`;
            pointEl.style.left=`${point.x}%`;
            pointEl.style.top=`${point.y}%`;
            document.getElementById('imageContainer').appendChild(pointEl);
            currentPoint=point;
            activePoint=pointEl;
        }
        
        function updatePointPosition(){
            if(!currentPoint)return;
            currentPoint.x=parseInt(document.getElementById('xSlider').value);
            currentPoint.y=parseInt(document.getElementById('ySlider').value);
            document.getElementById('xValue').textContent=currentPoint.x;
            document.getElementById('yValue').textContent=currentPoint.y;
            const pointEl=document.getElementById(`point-${currentPoint.id}`);
            if(pointEl){
                pointEl.style.left=`${currentPoint.x}%`;
                pointEl.style.top=`${currentPoint.y}%`;
            }
            drawMeasurementLines();
        }
        
        // 优化的拖拽逻辑
        function startDrag(e){
            if(e.target.classList.contains('measure-point') && currentStep<=21){
                e.preventDefault();
                isDragging=true;
                activePoint=e.target;
            }
        }
        
        function startDragTouch(e){
            if(e.touches.length!==1||currentStep>21)return;
            const touch=e.touches[0];
            const target=document.elementFromPoint(touch.clientX,touch.clientY);
            if(target&&target.classList.contains('measure-point')){
                e.preventDefault();
                isDragging=true;
                activePoint=target;
            }
        }
        
        function doDrag(e){
            if(!isDragging||!activePoint||currentStep>21)return;
            e.preventDefault();
            const rect=document.getElementById('imageContainer').getBoundingClientRect();
            let x=((e.clientX-rect.left)/rect.width)*100;
            let y=((e.clientY-rect.top)/rect.height)*100;
            x=Math.max(0,Math.min(100,x));
            y=Math.max(0,Math.min(100,y));
            updatePointPositionUI(x,y);
        }
        
        function doDragTouch(e){
            if(!isDragging||!activePoint||e.touches.length!==1||currentStep>21)return;
            e.preventDefault();
            const touch=e.touches[0];
            const rect=document.getElementById('imageContainer').getBoundingClientRect();
            let x=((touch.clientX-rect.left)/rect.width)*100;
            let y=((touch.clientY-rect.top)/rect.height)*100;
            x=Math.max(0,Math.min(100,x));
            y=Math.max(0,Math.min(100,y));
            updatePointPositionUI(x,y);
        }
        
        function endDrag(){
            isDragging=false;
            activePoint=null;
        }
        
        function handleImageClick(e){
            if(currentStep<1||currentStep>21||!currentPoint||isDragging)return;
            const rect=document.getElementById('imageContainer').getBoundingClientRect();
            let clientX,clientY;
            if(e.type.includes('touch')){
                clientX=e.touches[0].clientX;
                clientY=e.touches[0].clientY;
            }else{
                clientX=e.clientX;
                clientY=e.clientY;
            }
            let x=((clientX-rect.left)/rect.width)*100;
            let y=((clientY-rect.top)/rect.height)*100;
            x=Math.max(0,Math.min(100,x));
            y=Math.max(0,Math.min(100,y));
            updatePointPositionUI(x,y);
        }
        
        function updatePointPositionUI(x,y){
            if(!currentPoint)return;
            currentPoint.x=Math.round(x);
            currentPoint.y=Math.round(y);
            document.getElementById('xSlider').value=currentPoint.x;
            document.getElementById('ySlider').value=currentPoint.y;
            document.getElementById('xValue').textContent=currentPoint.x;
            document.getElementById('yValue').textContent=currentPoint.y;
            const pointEl=document.getElementById(`point-${currentPoint.id}`);
            if(pointEl){
                pointEl.style.left=`${currentPoint.x}%`;
                pointEl.style.top=`${currentPoint.y}%`;
            }
            drawMeasurementLines();
        }
        
        function drawMeasurementLines(){
            document.querySelectorAll('.measure-line,.line-label').forEach(el=>el.remove());
            if(currentStep>=19)drawLine(1,19,'#4b6cb7','面部高度');
            if(currentStep>=21)drawLine(20,21,'#4b6cb7','面部宽度');
            if(currentStep>=4)drawLine(3,4,'#28a745','眉毛宽度');
            if(currentStep>=8)drawLine(7,8,'#28a745','眼外角宽度');
            if(currentStep>=10)drawLine(9,10,'#28a745','眼间距');
            if(currentStep>=12)drawLine(11,12,'#dc3545','鼻子长度');
            if(currentStep>=14)drawLine(13,14,'#dc3545','鼻子宽度');
            if(currentStep>=16)drawLine(15,16,'#ffc107','嘴巴宽度');
            if(currentStep>=18)drawLine(17,18,'#ffc107','嘴唇高度');
        }
        
        function drawLine(p1Id,p2Id,color,label){
            const p1=points.find(p=>p.id===p1Id);
            const p2=points.find(p=>p.id===p2Id);
            if(!p1||!p2)return;
            const p1El=document.getElementById(`point-${p1Id}`);
            const p2El=document.getElementById(`point-${p2Id}`);
            if(!p1El||!p2El)return;
            const rect=document.getElementById('imageContainer').getBoundingClientRect();
            const p1Rect=p1El.getBoundingClientRect();
            const p2Rect=p2El.getBoundingClientRect();
            const x1=p1Rect.left+p1Rect.width/2-rect.left;
            const y1=p1Rect.top+p1Rect.height/2-rect.top;
            const x2=p2Rect.left+p2Rect.width/2-rect.left;
            const y2=p2Rect.top+p2Rect.height/2-rect.top;
            const len=Math.sqrt((x2-x1)**2+(y2-y1)**2);
            const angle=Math.atan2(y2-y1,x2-x1)*180/Math.PI;
            const line=document.createElement('div');
            line.className='measure-line';
            line.style.width=`${len}px`;
            line.style.height='2px';
            line.style.left=`${x1}px`;
            line.style.top=`${y1}px`;
            line.style.transform=`rotate(${angle}deg)`;
            line.style.backgroundColor=color;
            line.style.opacity='0.7';
            
            // 只有在非报告模式下才显示标签
            if(!document.getElementById('imageContainer').classList.contains('report-mode')){
                const labelX=x1+(x2-x1)/2;
                const labelY=y1+(y2-y1)/2;
                const lineLabel=document.createElement('div');
                lineLabel.className='line-label';
                lineLabel.textContent=label;
                lineLabel.style.left=`${labelX}px`;
                lineLabel.style.top=`${labelY-20}px`;
                lineLabel.style.backgroundColor=color;
                document.getElementById('imageContainer').appendChild(lineLabel);
            }
            
            document.getElementById('imageContainer').appendChild(line);
        }
        
        function goToNextPoint(){
            if(currentStep<21){
                currentStep++;
                showCurrentPoint();
                updateProgress();
            }else if(currentStep===21){
                completeMeasurement();
            }
        }
        
        function goToPrevPoint(){
            if(currentStep>1){
                currentStep--;
                showCurrentPoint();
                updateProgress();
            }
        }
        
        function completeMeasurement(){
            currentStep=22;
            updateProgress();
            document.getElementById('analyzeBtn').style.display='block';
            document.getElementById('sliderContainer').style.display='none';
            document.getElementById('currentPointInfo').style.display='none';
            showAllMeasurementPoints();
        }
        
        function showAllMeasurementPoints(){
            document.querySelectorAll('.measure-point').forEach(el=>el.remove());
            points.forEach(point=>{
                const pointEl=document.createElement('div');
                pointEl.className='measure-point inactive';
                pointEl.id=`point-${point.id}`;
                pointEl.style.left=`${point.x}%`;
                pointEl.style.top=`${point.y}%`;
                document.getElementById('imageContainer').appendChild(pointEl);
            });
            drawAllMeasurementLines();
        }
        
        function drawAllMeasurementLines(){
            // 进入报告模式，隐藏标签和禁止交互
            document.getElementById('imageContainer').classList.add('report-mode');
            document.querySelectorAll('.measure-line,.line-label').forEach(el=>el.remove());
            drawLine(1,19,'#4b6cb7','面部高度');
            drawLine(20,21,'#4b6cb7','面部宽度');
            drawLine(3,4,'#28a745','眉毛宽度');
            drawLine(7,8,'#28a745','眼外角宽度');
            drawLine(9,10,'#28a745','眼间距');
            drawLine(11,12,'#dc3545','鼻子长度');
            drawLine(13,14,'#dc3545','鼻子宽度');
            drawLine(15,16,'#ffc107','嘴巴宽度');
            drawLine(17,18,'#ffc107','嘴唇高度');
        }
        
        function openCamera(){
            document.getElementById('cameraModal').style.display='flex';
            navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}})
                .then(mediaStream=>{
                    stream=mediaStream;
                    document.getElementById('cameraFeed').srcObject=stream;
                })
                .catch(error=>{
                    console.error('访问摄像头出错:',error);
                    alert('无法访问摄像头，请确保已授予摄像头权限。');
                    closeCamera();
                });
        }
        
        function closeCamera(){
            if(stream){
                stream.getTracks().forEach(track=>track.stop());
                stream=null;
            }
            document.getElementById('cameraModal').style.display='none';
        }
        
        function capturePhoto(){
            const canvas=document.createElement('canvas');
            canvas.width=document.getElementById('cameraFeed').videoWidth;
            canvas.height=document.getElementById('cameraFeed').videoHeight;
            const ctx=canvas.getContext('2d');
            ctx.translate(canvas.width,0);
            ctx.scale(-1,1);
            ctx.drawImage(document.getElementById('cameraFeed'),0,0,canvas.width,canvas.height);
            loadImage(canvas.toDataURL('image/png'));
            closeCamera();
        }
        
        // 面部比例分析 - 根据性别科学计算
        function analyzeFaceProportions(){
            currentStep=23;
            updateProgress();
            
            const proportions=calculateAllProportions();
            const overallScore=calculateOverallScore(proportions);
            updateResults(overallScore,proportions);
            
            document.getElementById('resultSection').style.display='block';
            document.getElementById('instructions').style.display='none';
            document.getElementById('analyzeBtn').style.display='none';
            
            document.getElementById('resultSection').scrollIntoView({behavior:'smooth',block:'start'});
            drawAllMeasurementLines();
        }
        
        function calculateAllProportions(){
            return {
                faceHeight:calculateFaceHeightRatio(),
                faceWidth:calculateFaceWidthRatio(),
                faceShape:calculateFaceShape(),
                eyebrow:calculateEyebrowRatio(),
                eyes:calculateEyesRatio(),
                nose:calculateNoseRatio(),
                mouth:calculateMouthRatio(),
                symmetry:calculateSymmetry(),
                goldenRatio:calculateGoldenRatio()
            };
        }
        
        // 各计算函数（基于性别差异）
        function calculateFaceHeightRatio(){
            const hairline=points.find(p=>p.id===1);
            const forehead=points.find(p=>p.id===2);
            const noseRoot=points.find(p=>p.id===11);
            const chin=points.find(p=>p.id===19);
            
            const total=Math.abs(chin.y-hairline.y);
            const upper=Math.abs(forehead.y-hairline.y);
            const middle=Math.abs(noseRoot.y-forehead.y);
            const lower=Math.abs(chin.y-noseRoot.y);
            
            const upperRatio=(upper/total)*100;
            const middleRatio=(middle/total)*100;
            const lowerRatio=(lower/total)*100;
            
            const idealUpper=selectedGender==='male'?34:33;
            const idealMiddle=selectedGender==='male'?33:34;
            const idealLower=selectedGender==='male'?33:33;
            const deviation=Math.abs(upperRatio-idealUpper)+Math.abs(middleRatio-idealMiddle)+Math.abs(lowerRatio-idealLower);
            const score=Math.max(0,100-deviation);
            
            return{
                name:"三庭比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    upperRatio:Math.round(upperRatio)+"%",
                    middleRatio:Math.round(middleRatio)+"%",
                    lowerRatio:Math.round(lowerRatio)+"%",
                    ideal:`${idealUpper}% : ${idealMiddle}% : ${idealLower}%`,
                    assessment:score>=80?"符合理想三庭比例":"三庭比例需优化"
                }
            };
        }
        
        function calculateFaceWidthRatio(){
            const leftCheek=points.find(p=>p.id===20);
            const rightCheek=points.find(p=>p.id===21);
            const forehead=points.find(p=>p.id===2);
            const chin=points.find(p=>p.id===19);
            
            const faceWidth=Math.abs(rightCheek.x-leftCheek.x);
            const faceHeight=Math.abs(chin.y-forehead.y);
            const ratio=(faceWidth/faceHeight)*100;
            
            const idealRatio=selectedGender==='male'?78:72;
            const deviation=Math.abs(ratio-idealRatio);
            const score=Math.max(0,100-deviation);
            
            return{
                name:"面部宽高比",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    ratio:Math.round(ratio)+"%",
                    ideal:idealRatio+"%",
                    assessment:score>=80?"面部宽高比协调":"面部比例需调整"
                }
            };
        }
        
        function calculateFaceShape(){
            const leftCheek=points.find(p=>p.id===20);
            const rightCheek=points.find(p=>p.id===21);
            const chin=points.find(p=>p.id===19);
            const forehead=points.find(p=>p.id===2);
            
            const faceWidth=Math.abs(rightCheek.x-leftCheek.x);
            const faceHeight=Math.abs(chin.y-forehead.y);
            const ratio=faceWidth/faceHeight;
            
            let shapeType="椭圆形", score=85;
            if(ratio>0.85) shapeType="圆形脸";
            else if(ratio<0.7) shapeType="长形脸";
            
            const idealShape=selectedGender==='male'?"方形或椭圆形":"椭圆形或心形";
            
            return{
                name:"脸型分析",
                score:score,
                rating:getRating(score),
                details:{
                    faceType:shapeType,
                    ideal:idealShape,
                    assessment:shapeType===idealShape?"脸型符合性别美学标准":"脸型有优化空间"
                }
            };
        }
        
        function calculateEyebrowRatio(){
            const leftEyebrow=points.find(p=>p.id===3);
            const rightEyebrow=points.find(p=>p.id===4);
            const leftEye=points.find(p=>p.id===7);
            const rightEye=points.find(p=>p.id===8);
            
            const eyebrowWidth=Math.abs(rightEyebrow.x-leftEyebrow.x);
            const eyeWidth=Math.abs(rightEye.x-leftEye.x);
            const ratio=(eyebrowWidth/eyeWidth)*100;
            
            const idealRatio=selectedGender==='male'?115:105;
            const deviation=Math.abs(ratio-idealRatio);
            const score=Math.max(0,100-deviation);
            
            return{
                name:"眉毛比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    ratio:Math.round(ratio)+"%",
                    ideal:idealRatio+"%",
                    assessment:score>=80?"眉毛比例协调":"眉毛比例需调整"
                }
            };
        }
        
        function calculateEyesRatio(){
            const leftOuter=points.find(p=>p.id===7);
            const rightOuter=points.find(p=>p.id===8);
            const leftInner=points.find(p=>p.id===9);
            const rightInner=points.find(p=>p.id===10);
            
            const eyeOuterWidth=Math.abs(rightOuter.x-leftOuter.x);
            const eyeInnerWidth=Math.abs(rightInner.x-leftInner.x);
            const singleEyeWidth=eyeOuterWidth/2;
            const eyeSpacingRatio=(eyeInnerWidth/singleEyeWidth)*100;
            
            const idealRatio=selectedGender==='male'?100:110;
            const deviation=Math.abs(eyeSpacingRatio-idealRatio);
            const score=Math.max(0,100-deviation/2);
            
            return{
                name:"眼睛比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    eyeSpacingRatio:Math.round(eyeSpacingRatio)+"%",
                    ideal:idealRatio+"%",
                    assessment:score>=80?"眼间距比例协调":"眼间距需注意"
                }
            };
        }
        
        function calculateNoseRatio(){
            const noseRoot=points.find(p=>p.id===11);
            const noseTip=points.find(p=>p.id===12);
            const leftWing=points.find(p=>p.id===13);
            const rightWing=points.find(p=>p.id===14);
            
            const noseLength=Math.abs(noseTip.y-noseRoot.y);
            const noseWidth=Math.abs(rightWing.x-leftWing.x);
            const ratio=(noseLength/noseWidth)*100;
            
            const idealRatio=selectedGender==='male'?220:190;
            const deviation=Math.abs(ratio-idealRatio);
            const score=Math.max(0,100-deviation/3);
            
            return{
                name:"鼻子比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    ratio:Math.round(ratio)+"%",
                    ideal:idealRatio+"%",
                    assessment:score>=80?"鼻子比例协调":"鼻子比例需注意"
                }
            };
        }
        
        function calculateMouthRatio(){
            const leftCorner=points.find(p=>p.id===15);
            const rightCorner=points.find(p=>p.id===16);
            const upperLip=points.find(p=>p.id===17);
            const lowerLip=points.find(p=>p.id===18);
            
            const mouthWidth=Math.abs(rightCorner.x-leftCorner.x);
            const mouthHeight=Math.abs(lowerLip.y-upperLip.y);
            const ratio=(mouthWidth/mouthHeight)*100;
            
            const idealRatio=selectedGender==='male'?320:280;
            const deviation=Math.abs(ratio-idealRatio);
            const score=Math.max(0,100-deviation/4);
            
            return{
                name:"嘴巴比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    ratio:Math.round(ratio)+"%",
                    ideal:idealRatio+"%",
                    assessment:score>=80?"嘴巴比例协调":"嘴巴比例需注意"
                }
            };
        }
        
        function calculateSymmetry(){
            let totalDeviation=0;
            const pairs=[[3,4],[5,6],[7,8],[9,10],[13,14],[15,16],[20,21]];
            
            pairs.forEach(pair=>{
                const p1=points.find(p=>p.id===pair[0]);
                const p2=points.find(p=>p.id===pair[1]);
                if(p1&&p2){
                    totalDeviation+=Math.abs(p1.x-(100-p2.x))+Math.abs(p1.y-p2.y);
                }
            });
            
            const avgDeviation=totalDeviation/(pairs.length*2);
            const score=Math.max(0,100-avgDeviation*3);
            
            return{
                name:"面部对称性",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    deviation:Math.round(avgDeviation*100)/100,
                    ideal:"0",
                    assessment:score>=80?"对称性良好":score>=60?"轻微不对称":"明显不对称"
                }
            };
        }
        
        function calculateGoldenRatio(){
            const hairline=points.find(p=>p.id===1);
            const noseTip=points.find(p=>p.id===12);
            const chin=points.find(p=>p.id===19);
            
            const totalHeight=Math.abs(chin.y-hairline.y);
            const lowerHeight=Math.abs(chin.y-noseTip.y);
            const ratio=lowerHeight/totalHeight;
            
            const idealRatio=0.618;
            const deviation=Math.abs(ratio-idealRatio)/idealRatio*100;
            const score=Math.max(0,100-deviation);
            
            return{
                name:"黄金比例",
                score:Math.round(score),
                rating:getRating(score),
                details:{
                    ratio:Math.round(ratio*1000)/1000,
                    ideal:"0.618",
                    assessment:deviation<10?"接近黄金比例":deviation<20?"接近理想比例":"偏离理想比例"
                }
            };
        }
        
        function calculateOverallScore(proportions){
            let total=0;
            let count=0;
            
            for(const key in proportions){
                if(proportions[key].score){
                    total+=proportions[key].score;
                    count++;
                }
            }
            
            return count>0?Math.round(total/count):70;
        }
        
        function getRating(score){
            if(score>=90)return{grade:'A',class:'rating-A',text:'优秀'};
            if(score>=80)return{grade:'B',class:'rating-B',text:'良好'};
            if(score>=70)return{grade:'C',class:'rating-C',text:'一般'};
            return{grade:'D',class:'rating-D',text:'待改善'};
        }
        
        function updateResults(overallScore,proportions){
            const rating=getRating(overallScore);
            document.getElementById('overallGrade').textContent=rating.grade;
            document.getElementById('proportionScore').textContent=overallScore;
            
            const assessmentList=document.getElementById('assessmentList');
            assessmentList.innerHTML='';
            
            for(const key in proportions){
                const prop=proportions[key];
                const barStyle=getScoreBarStyle(prop.score);
                
                const item=document.createElement('li');
                item.className='assessment-item';
                item.innerHTML=`
                    <span class="assessment-title">${prop.name}</span>
                    <span class="assessment-score">${prop.score}分</span>
                    <div class="score-bar">
                        <div class="score-fill ${barStyle.className}" style="width:${prop.score}%"></div>
                    </div>
                    <span class="assessment-rating ${prop.rating.class}">${prop.rating.grade}</span>
                `;
                
                assessmentList.appendChild(item);
            }
            
            generateDetailedReport(overallScore,rating,proportions);
        }
        
        function getScoreBarStyle(score){
            if(score>=85)return{className:'excellent'};
            if(score>=70)return{className:'good'};
            if(score>=60)return{className:'average'};
            return{className:'poor'};
        }
        
        function generateDetailedReport(overallScore,rating,proportions){
            let report=`
                <div class="report-section">
                    <h4>总体评估</h4>
                    <p>您的面部比例综合得分为 <strong>${overallScore}/100</strong>，评级为 <span class="assessment-rating ${rating.class}">${rating.grade} (${rating.text})</span>。</p>
                    <p>${overallScore>=85?'您的面部比例非常协调，符合美学标准。':
                        overallScore>=70?'您的面部比例整体协调，有少数方面可以优化。':
                        overallScore>=60?'您的面部比例有改善空间，部分指标偏离理想值。':
                        '您的面部比例有显著改善空间，请关注以下建议。'}</p>
                </div>
                
                <div class="report-section">
                    <h4>详细分析报告</h4>
            `;
            
            for(const key in proportions){
                const prop=proportions[key];
                report+=`
                    <div style="margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #f0f0f0">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <strong>${prop.name}</strong>
                            <span class="assessment-rating ${prop.rating.class}" style="font-size:0.75rem">${prop.rating.grade} (${prop.score}分)</span>
                        </div>
                `;
                
                if(prop.details){
                    for(const detailKey in prop.details){
                        if(['assessment'].includes(detailKey)) continue;
                        if(typeof prop.details[detailKey]==='string'){
                            report+=`<div><strong>${detailKey}:</strong> ${prop.details[detailKey]}</div>`;
                        }
                    }
                    
                    if(prop.details.assessment){
                        report+=`<div style="margin-top:6px">${prop.details.assessment}</div>`;
                    }
                }
                
                report+=`</div>`;
            }
            
            report+=`</div>`;
            
            // 性别特定建议
            const genderAdvice=selectedGender==='male'?
                '男性面部美学：轮廓分明、线条硬朗、三庭比例均衡、五官立体协调。建议关注面部轮廓的立体感。':
                '女性面部美学：轮廓柔和、线条流畅、五官协调精致。建议关注面部柔和度和五官协调性。';
            
            report+=`
                <div class="report-suggestion">
                    <h5>个性化建议</h5>
                    <p>${genderAdvice}</p>
                    <p>基于您的${selectedGender==='male'?'男性':'女性'}面部特征分析，建议结合专业美容顾问的意见进行综合判断。</p>
                </div>
                
                <div style="margin-top:15px;padding-top:12px;border-top:1px solid #e9ecef;font-size:0.75rem;color:#6c757d">
                    <p><em>重要提示：本分析基于${selectedGender==='male'?'男性':'女性'}面部比例测量理论，结果仅供参考。</em></p>
                </div>
            `;
            
            document.getElementById('reportText').innerHTML=report;
        }
    </script>
</body>
</html>